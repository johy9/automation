name: Internal PSI Monitoring

run-name: "Action ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.action || github.event_name }} - internal-psi-monitoring - Env ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || github.ref }} - #${{ github.run_number }}"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform Action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: 'Target Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read # Only read permission is needed when using static secrets
  id-token: write # Needed for OIDC to assume AWS Role

jobs:
  # 1. Orchestration Job: Determines which environment(s) to run
  determine_envs:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set_envs.outputs.environments }}
    steps:
      - id: set_envs
        run: |
          # Default to running both environments on push/PR
          ENVS='["staging", "production"]'
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET_ENV="${{ github.event.inputs.environment }}"
            # If manual dispatch, run only the specified environment
            ENVS="[\"$TARGET_ENV\"]"
          fi
          
          echo "environments=$ENVS" >> $GITHUB_OUTPUT

  # 2. Deployment Job: Runs the shared logic for each environment in the matrix
  deploy:
    name: Deploy to ${{ matrix.env }}
    needs: determine_envs
    runs-on: ubuntu-latest
    
    # Define the Matrix using the output from the previous job
    strategy:
      fail-fast: true
      matrix:
        env: ${{ fromJson(needs.determine_envs.outputs.environments) }} 

    # Use the GitHub Environment feature for protection rules (e.g., Prod manual approval)
    environment: ${{ matrix.env }} 
    
    defaults:
      run:
        # Dynamic working directory
        working-directory: projects/internal-psi-monitoring/${{ matrix.env }}
        
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set Environment Variables
        id: env_vars
        run: |
          # Creates the variable name needed to fetch the tfvars content (e.g., STAGING_TFVARS)
          ENV_UPPER=$(echo ${{ matrix.env }} | tr '[:lower:]' '[:upper:]')
          echo "tfvars_var_name=${ENV_UPPER}_TFVARS" >> $GITHUB_OUTPUT
          
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4 # Using the latest v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE }}
      
      - name: Configure Git
        run: |
          git config --global url."https://oauth2:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.11.0

      - name: Create terraform.tfvars
        # Dynamically fetches the correct repository variable (STAGING_TFVARS or PRODUCTION_TFVARS)
        env:
          TFVARS: ${{ vars[steps.env_vars.outputs.tfvars_var_name] }}
        run: |
          if [ ! -f terraform.tfvars ]; then
            echo "$TFVARS" > terraform.tfvars
          fi

      # ----------------------------------------------------
      # CORE TERRAFORM STEPS (REMAINS THE SAME FOR ALL ENVIRONMENTS)
      # ----------------------------------------------------
      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate
      
      # Plan (Normal) - Runs on PR, Push, or Manual Plan/Apply
      - name: Terraform Plan
        id: plan
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.action != 'destroy'
        run: terraform plan -out=tfplan -input=false

      # Plan (Destroy) - Runs only on Manual Destroy
      - name: Terraform Plan (Destroy)
        id: plan-destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.ref == 'refs/heads/main'
        run: terraform plan -destroy -out=tfplan -input=false

      - name: Generate Timestamp & Convert Plan to JSON
        id: plan_artifact
        if: steps.plan.outcome == 'success' || steps.plan-destroy.outcome == 'success'
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d-%H-%M-%S')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          PLAN_FILENAME=internal-psi-monitoring-${{ matrix.env }}_$TIMESTAMP.json
          terraform show -json tfplan > $PLAN_FILENAME
          echo "plan_filename=$PLAN_FILENAME" >> $GITHUB_OUTPUT

      - name: Upload Plan JSON
        if: steps.plan.outcome == 'success' || steps.plan-destroy.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: plan-${{ matrix.env }}-${{ steps.plan_artifact.outputs.timestamp }}
          path: projects/internal-psi-monitoring/${{ matrix.env }}/${{ steps.plan_artifact.outputs.plan_filename }}

      # Apply - Runs only on Manual Apply or Destroy (on main branch)
      - name: Terraform Apply
        if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'apply' || github.event.inputs.action == 'destroy') && github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve -input=false tfplan
