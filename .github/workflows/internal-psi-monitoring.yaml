name: Internal PSI Monitoring

run-name: "Action ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.action || github.event_name }} - internal-psi-monitoring - Env ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || github.ref }} - Component ${{ github.event.inputs.component }} - #${{ github.run_number }}"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform Action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: 'Target Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          # - staging
          - production
      component:
        description: 'Component'
        required: true
        type: choice
        options:
          - vpc
          - eks
          - addons

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  # 1. Orchestration: Determine environments
  determine_envs:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set_envs.outputs.environments }}
    steps:
      - id: set_envs
        run: |
          ENVS='["staging", "production"]'
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET_ENV="${{ github.event.inputs.environment }}"
            ENVS="[\"$TARGET_ENV\"]"
          fi
          echo "environments=$ENVS" >> $GITHUB_OUTPUT

  # 2. Plan Job: Runs Terraform Plan and uploads the artifact
  plan:
    name: Plan ${{ matrix.env }}
    needs: determine_envs
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        env: ${{ fromJson(needs.determine_envs.outputs.environments) }}
    
    defaults:
      run:
        working-directory: projects/internal-psi-monitoring/${{ matrix.env }}/${{ github.event.inputs.component }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set Environment Variables
        id: env_vars
        run: |
          ENV_UPPER=$(echo ${{ matrix.env }} | tr '[:lower:]' '[:upper:]')
          echo "tfvars_var_name=${ENV_UPPER}_TFVARS" >> $GITHUB_OUTPUT

      # - name: Configure AWS Credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-region: us-east-1
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4 # Using the latest v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE }}
      
      - name: Configure Git
        run: |
          git config --global url."https://oauth2:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
      
      - name: Get Caller Identity
        run: |
          ARN=$(aws sts get-caller-identity --query Arn --output text)
          echo "TF_VAR_github_actions_role_arn=$ARN" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config --global url."https://oauth2:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.11.0

      - name: Create terraform.tfvars
        env:
          TFVARS: ${{ vars[steps.env_vars.outputs.tfvars_var_name] }}
        run: |
          if [ ! -f terraform.tfvars ]; then
            echo "$TFVARS" > terraform.tfvars
          fi

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate
      
      - name: Terraform Plan
        id: plan
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.action != 'destroy'
        run: terraform plan -out=tfplan -input=false

      - name: Terraform Plan (Destroy)
        id: plan-destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
        run: terraform plan -destroy -out=tfplan -input=false

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.env }}
          path: projects/internal-psi-monitoring/${{ matrix.env }}/${{ github.event.inputs.component }}/tfplan

  # 3. Apply Job: Runs Terraform Apply using the saved plan
  apply:
    name: Apply ${{ matrix.env }}
    needs: [determine_envs, plan]
    # Only run if the action is 'apply' or 'destroy'
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'apply' || github.event.inputs.action == 'destroy')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        env: ${{ fromJson(needs.determine_envs.outputs.environments) }}
    
    # This enforces the Manual Approval rule configured in GitHub Environments
    environment: ${{ matrix.env }}
    
    defaults:
      run:
        working-directory: projects/internal-psi-monitoring/${{ matrix.env }}/${{ github.event.inputs.component }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set Environment Variables
        id: env_vars
        run: |
          ENV_UPPER=$(echo ${{ matrix.env }} | tr '[:lower:]' '[:upper:]')
          echo "tfvars_var_name=${ENV_UPPER}_TFVARS" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4 # Using the latest v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE }}
  
      - name: Get Caller Identity
        run: |
          ARN=$(aws sts get-caller-identity --query Arn --output text)
          echo "TF_VAR_github_actions_role_arn=$ARN" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config --global url."https://oauth2:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.11.0

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ matrix.env }}
          path: projects/internal-psi-monitoring/${{ matrix.env }}/${{ github.event.inputs.component }}

      - name: Create terraform.tfvars
        env:
          TFVARS: ${{ vars[steps.env_vars.outputs.tfvars_var_name] }}
        run: |
          if [ ! -f terraform.tfvars ]; then
            echo "$TFVARS" > terraform.tfvars
          fi

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve -input=false tfplan
